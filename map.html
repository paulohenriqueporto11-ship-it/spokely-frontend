<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spokely - Mapa</title>
    <link rel="icon" href="data:,">
    
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <div id="loading">CARREGANDO MAPA...</div>

    <header>
        <a href="index.html" class="logo">SPOKELY</a>
        <div class="stats">
            <div class="badge"><span class="material-icons-round icon-heart">favorite</span> <span id="livesDisplay">--</span></div>
            <div class="badge"><span class="material-icons-round icon-xp">bolt</span> <span id="xpDisplay">--</span></div>
        </div>
    </header>

    <main id="mainMap">
        <div class="map-scroll" id="mapTrack">
            </div>
    </main>

    <div id="overlay-quiz" class="overlay">
        <div class="quiz-container">
            <div class="quiz-top">
                <span onclick="quitQuiz()" style="cursor:pointer; color:#888;">‚úï</span>
                <div class="progress-bar"><div id="lessonProgress"></div></div>
                <span style="color:#ff4d4d;">‚ù§</span>
            </div>
            <div class="quiz-content">
                <h2 id="qText" style="margin-bottom:20px;">Carregando...</h2>
                <div id="qOptions"></div>
            </div>
        </div>
    </div>

    <nav class="bottom-nav">
        <a href="index.html" class="nav-link">
            <span class="material-icons-round">home</span> <span>In√≠cio</span>
        </a>
        <a href="map.html" class="nav-link active">
            <span class="material-icons-round">map</span> <span>Estudar</span>
        </a>
        <a href="profile.html" class="nav-link">
            <span class="material-icons-round">person</span> <span>Perfil</span>
        </a>
    </nav>

    <script src="js/config.js"></script>
    <script src="js/script.js"></script>

    <script>
        // Vari√°veis Locais
        let currentLevel = 1;
        let session = { correct: 0, goal: 5, questions: [], answeredIds: [] };

        // Carrega Mapa ao iniciar
        window.addEventListener('load', async () => {
            const data = await updateHeader(); 
            
            if(data) {
                currentLevel = data.current_level || 1;
                renderMap();
                setTimeout(scrollToLevel, 300);
            }
            
            // Remove Loading
            const loadScreen = document.getElementById('loading');
            if(loadScreen) loadScreen.style.display = 'none';
        });

        function renderMap() {
            const track = document.getElementById('mapTrack');
            track.innerHTML = ''; 
            for (let i = 1; i <= 50; i++) { 
                const node = document.createElement('div');
                node.className = 'node';
                node.innerText = i;
                
                if (i < currentLevel) {
                    node.classList.add('done');
                    node.innerText = '‚úì';
                } else if (i === currentLevel) {
                    node.classList.add('curr');
                    const av = document.createElement('div');
                    av.className = 'avatar';
                    node.appendChild(av);
                    node.onclick = () => startSession();
                } else {
                    node.classList.add('locked');
                    node.innerHTML = '<span class="material-icons-round">lock</span>';
                }
                track.appendChild(node);
            }
        }

        function scrollToLevel() {
            const el = document.querySelector('.node.curr');
            if(el) el.scrollIntoView({ inline: 'center', behavior: 'smooth' });
        }

        // --- SISTEMA DE QUIZ ---
        async function startSession() {
            const lives = document.getElementById('livesDisplay').innerText;
            if(parseInt(lives) <= 0) {
                document.getElementById('overlay-quiz').style.display = 'flex';
                showFeedback('gameover');
                return;
            }
            
            // Reseta a UI do Quiz (caso tenha ficado tela de vit√≥ria antiga)
            document.querySelector('.quiz-content').innerHTML = `
                <h2 id="qText" style="margin-bottom:20px;">Carregando...</h2>
                <div id="qOptions"></div>
            `;
            
            // UI de Carregamento
            document.getElementById('overlay-quiz').style.display = 'flex';
            document.getElementById('qText').innerText = "Carregando atividade...";
            document.getElementById('qOptions').innerHTML = "";

            const difficulty = 'easy'; 

            try {
                const res = await fetch(`${API_URL}/get-activity?user_id=${USER_ID}&difficulty=${difficulty}`);
                const data = await res.json();

                if(!data.success) {
                    alert(data.error || "Erro ao buscar atividades."); // Fallback simples
                    document.getElementById('overlay-quiz').style.display = 'none';
                    return;
                }

                session.questions = data.questions;
                session.correct = 0;
                session.goal = session.questions.length;
                session.answeredIds = [];
                
                updateBar();
                nextQuestion();

            } catch (e) {
                console.error(e);
                alert("Erro de conex√£o.");
                document.getElementById('overlay-quiz').style.display = 'none';
            }
        }

        function nextQuestion() {
            const q = session.questions.pop(); 
            
            if (!q) return; 

            session.currentQ = q; 

            document.getElementById('qText').innerText = q.t;
            const opts = document.getElementById('qOptions');
            opts.innerHTML = '';
            
            q.o.forEach((opt, idx) => {
                const btn = document.createElement('button');
                btn.className = 'btn-opt';
                btn.innerText = opt;
                btn.onclick = () => check(idx, q.c, btn);
                opts.appendChild(btn);
            });
        }

        async function check(sel, cor, btn) {
            const all = document.querySelectorAll('.btn-opt');
            all.forEach(b => b.disabled = true);

            if(sel === cor) {
                // ACERTOU
                btn.classList.add('correct');
                session.correct++;
                session.answeredIds.push(session.currentQ.id); 
                updateBar();
                
                setTimeout(async () => {
                    if(session.questions.length === 0 || session.correct >= session.goal) {
                         await finishLevel();
                    } else {
                        nextQuestion();
                    }
                }, 1000);
            } else {
                // ERROU
                btn.classList.add('wrong');
                all[cor].classList.add('correct'); 
                
                await apiLoseLife(); 
                const livesData = await updateHeader(); 
                
                setTimeout(() => {
                    if(livesData && livesData.lives <= 0) {
                         showFeedback('gameover');
                    } else {
                        if(session.questions.length > 0) {
                            nextQuestion();
                        } else {
                            showFeedback('retry');
                        }
                    }
                }, 1500);
            }
        }

        function updateBar() {
            document.getElementById('lessonProgress').style.width = `${(session.correct/session.goal)*100}%`;
        }

        // --- UI OTIMISTA (Sem delay) ---
        async function finishLevel() {
            // 1. Mostra a vit√≥ria NA HORA
            showFeedback('victory');

            // 2. Salva no banco em segundo plano
            try {
                await fetch(`${API_URL}/complete-level`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ 
                        user_id: USER_ID, 
                        xp_reward: 50,
                        questions_ids: session.answeredIds
                    })
                });
            } catch(e) { console.error("Erro ao salvar progresso", e); }
        }

        // --- GERENCIADOR DE TELAS FINAIS (SEM ALERT) ---
        function showFeedback(type) {
            const contentDiv = document.querySelector('.quiz-content');
            let html = '';
            
            if (type === 'victory') {
                 
                html = `
                    <div class="feedback-content">
                        <span class="feedback-icon">üèÜ</span>
                        <div class="feedback-title" style="color:var(--primary)">N√çVEL COMPLETADO!</div>
                        <p class="feedback-msg">Voc√™ ganhou +50 XP e subiu de n√≠vel!</p>
                        <button class="btn-action" onclick="location.reload()">CONTINUAR</button>
                    </div>
                `;
            } else if (type === 'gameover') {
                 
                html = `
                    <div class="feedback-content">
                        <span class="feedback-icon">üíî</span>
                        <div class="feedback-title" style="color:var(--danger)">SEM VIDAS!</div>
                        <p class="feedback-msg">Descanse um pouco e tente novamente.</p>
                        <button class="btn-action danger" onclick="location.reload()">SAIR</button>
                    </div>
                `;
            } else if (type === 'retry') {
                 html = `
                    <div class="feedback-content">
                        <span class="feedback-icon">üò¢</span>
                        <div class="feedback-title">N√ÉO FOI DESSA VEZ</div>
                        <p class="feedback-msg">Voc√™ n√£o acertou o suficiente.</p>
                        <button class="btn-action" onclick="location.reload()">TENTAR DE NOVO</button>
                    </div>
                `;
            }
            contentDiv.innerHTML = html;
        }

        async function quitQuiz() {
            if(confirm("Sair custa 1 vida. Confirmar?")) {
                await apiLoseLife();
                location.reload();
            }
        }
    </script>
</body>
</html>
