<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spokely - Mapa</title>
    <link rel="icon" href="data:,">
    
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">
    <link rel="stylesheet" href="css/style.css">
    
    <style>
        /* ESTILOS EXTRAS PARA OS NOVOS MODOS */
        
        /* Bot√£o Gigante de Ouvir */
        .audio-btn-container {
            display: flex;
            justify-content: center;
            margin-bottom: 20px;
        }
        .btn-audio-lg {
            background: #1cb0f6; /* Azul Duolingo */
            border: none;
            width: 100px;
            height: 100px;
            border-radius: 20px;
            box-shadow: 0 4px 0 #1480b3;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            transition: transform 0.1s;
        }
        .btn-audio-lg:active {
            transform: translateY(4px);
            box-shadow: none;
        }
        .btn-audio-lg span {
            font-size: 50px;
            color: white;
        }

        /* √Årea de Montar Frase */
        .assemble-area {
            min-height: 60px;
            border-bottom: 2px solid #333;
            margin-bottom: 30px;
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            padding: 10px;
            align-items: center;
            justify-content: center;
        }
        
        .word-bank {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
        }

        .word-tag {
            background: #1f1f1f;
            border: 1px solid #444;
            border-bottom: 3px solid #333;
            padding: 10px 20px;
            border-radius: 12px;
            cursor: pointer;
            font-size: 1.1rem;
            color: #eee;
            transition: all 0.2s;
            user-select: none;
        }
        
        .word-tag:active {
            transform: translateY(2px);
            border-bottom-width: 1px;
        }

        .word-tag.selected {
            background: #adff2f; /* Primary Green */
            color: #000;
            border-color: #adff2f;
        }

        .btn-check-assemble {
            margin-top: 30px;
            width: 100%;
            display: none; 
        }
    </style>
</head>
<body>
    <div id="loading">CARREGANDO MAPA...</div>

    <header>
        <a href="index.html" class="logo">SPOKELY</a>
        <div class="stats">
            <div class="badge"><span class="material-icons-round icon-heart">favorite</span> <span id="livesDisplay">--</span></div>
            <div class="badge"><span class="material-icons-round icon-xp">bolt</span> <span id="xpDisplay">--</span></div>
        </div>
    </header>

    <main id="mainMap">
        <div class="map-scroll" id="mapTrack">
            </div>
    </main>

    <div id="overlay-quiz" class="overlay">
        <div class="quiz-container">
            <div class="quiz-top">
                <span onclick="quitQuiz()" style="cursor:pointer; color:#888;">‚úï</span>
                <div class="progress-bar"><div id="lessonProgress"></div></div>
                <span style="color:#ff4d4d;">‚ù§</span>
            </div>
            
            <div class="quiz-content">
                <h2 id="qText" style="margin-bottom:20px; text-align:center;">Carregando...</h2>
                
                <div id="audioSection" class="audio-btn-container" style="display:none;">
                    <button class="btn-audio-lg" onclick="playCurrentAudio()">
                        <span class="material-icons-round">volume_up</span>
                    </button>
                </div>

                <div id="qOptions"></div>

                <div id="qAssemble" style="display:none;">
                    <div class="assemble-area" id="assembleLine"></div>
                    <div class="word-bank" id="assembleBank"></div>
                    <button class="btn-action btn-check-assemble" id="btnCheckAssemble" onclick="checkAssemble()">VERIFICAR</button>
                </div>
            </div>
        </div>
    </div>

    <nav class="bottom-nav">
        <a href="index.html" class="nav-link">
            <span class="material-icons-round">home</span> <span>In√≠cio</span>
        </a>
        <a href="map.html" class="nav-link active">
            <span class="material-icons-round">map</span> <span>Estudar</span>
        </a>
        <a href="profile.html" class="nav-link">
            <span class="material-icons-round">person</span> <span>Perfil</span>
        </a>
    </nav>

    <script src="js/config.js"></script>
    <script src="js/script.js"></script>

    <script>
        // --- SISTEMA DE √ÅUDIO ---
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        
        function playSound(type) {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            const osc = audioCtx.createOscillator();
            const gainNode = audioCtx.createGain();
            osc.connect(gainNode);
            gainNode.connect(audioCtx.destination);

            if (type === 'correct') {
                osc.type = 'sine';
                osc.frequency.setValueAtTime(600, audioCtx.currentTime);
                osc.frequency.exponentialRampToValueAtTime(1200, audioCtx.currentTime + 0.1);
                gainNode.gain.setValueAtTime(0.5, audioCtx.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.3);
                osc.start(); osc.stop(audioCtx.currentTime + 0.3);
            } else if (type === 'wrong') {
                osc.type = 'sawtooth';
                osc.frequency.setValueAtTime(150, audioCtx.currentTime);
                osc.frequency.linearRampToValueAtTime(100, audioCtx.currentTime + 0.3);
                gainNode.gain.setValueAtTime(0.5, audioCtx.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.3);
                osc.start(); osc.stop(audioCtx.currentTime + 0.3);
            } else if (type === 'pop') {
                osc.type = 'triangle';
                osc.frequency.setValueAtTime(800, audioCtx.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.05);
                osc.start(); osc.stop(audioCtx.currentTime + 0.05);
            }
        }

        function speakText(text) {
            if ('speechSynthesis' in window) {
                window.speechSynthesis.cancel();
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = 'en-US';
                utterance.rate = 0.85; // Um pouco mais lento para ficar claro
                window.speechSynthesis.speak(utterance);
            }
        }

        function playCurrentAudio() {
            if (session.currentQ && session.currentQ.audio_text) {
                speakText(session.currentQ.audio_text);
            }
        }

        // --- L√ìGICA DO JOGO ---
        let currentLevel = 1;
        let session = { correct: 0, goal: 5, questions: [], answeredIds: [], currentQ: null, assembleUser: [] };

        window.addEventListener('load', async () => {
            const data = await updateHeader(); 
            if(data) {
                currentLevel = data.current_level || 1;
                renderMap();
                setTimeout(scrollToLevel, 300);
            }
            const loadScreen = document.getElementById('loading');
            if(loadScreen) loadScreen.style.display = 'none';
        });

        function renderMap() {
            const track = document.getElementById('mapTrack');
            track.innerHTML = ''; 
            for (let i = 1; i <= 50; i++) { 
                const node = document.createElement('div');
                node.className = 'node';
                node.innerText = i;
                if (i < currentLevel) {
                    node.classList.add('done');
                    node.innerText = '‚úì';
                } else if (i === currentLevel) {
                    node.classList.add('curr');
                    const av = document.createElement('div');
                    av.className = 'avatar';
                    node.appendChild(av);
                    node.onclick = () => startSession();
                } else {
                    node.classList.add('locked');
                    node.innerHTML = '<span class="material-icons-round">lock</span>';
                }
                track.appendChild(node);
            }
        }

        function scrollToLevel() {
            const el = document.querySelector('.node.curr');
            if(el) el.scrollIntoView({ inline: 'center', behavior: 'smooth' });
        }

        async function startSession() {
            const lives = document.getElementById('livesDisplay').innerText;
            if(parseInt(lives) <= 0) {
                document.getElementById('overlay-quiz').style.display = 'flex';
                showFeedback('gameover');
                return;
            }
            
            // Reseta UI
            document.getElementById('overlay-quiz').style.display = 'flex';
            document.getElementById('qText').innerText = "Carregando...";
            document.getElementById('qOptions').style.display = 'none';
            document.getElementById('qAssemble').style.display = 'none';
            document.getElementById('audioSection').style.display = 'none';

            const difficulty = 'easy'; 

            try {
                const res = await fetch(`${API_URL}/get-activity?user_id=${USER_ID}&difficulty=${difficulty}`);
                const data = await res.json();

                if(!data.success) {
                    alert("Erro ao buscar atividades.");
                    document.getElementById('overlay-quiz').style.display = 'none';
                    return;
                }

                // Normaliza tipos se o backend for antigo
                session.questions = data.questions.map(q => {
                    // O backend envia 'content' dentro de 'q' no formato atual do server.js?
                    // N√£o, o seu server.js j√° formata: 
                    // { id, t: content.question, o: options/parts, c: index, ... }
                    // Precisamos garantir que ele passe o TYPE e o AUDIO_TEXT.
                    // O server.js atual pode N√ÉO estar passando 'type' e 'audio_text'.
                    
                    // FIX R√ÅPIDO NO FRONTEND PARA DADOS MOCKADOS/NOVOS:
                    // Se o server n√£o mandar, a gente assume pelo formato.
                    // Mas como voc√™ inseriu no banco, o ideal √© o server mandar.
                    // Vou assumir que o server manda tudo q tem no banco.
                    
                    // Se o server n√£o estiver mandando 'type', o c√≥digo vai quebrar.
                    // Como n√£o posso editar o server.js agora, vou torcer para ele mandar "select *".
                    // O server.js mandava: id, t, o, c. 
                    // Ele N√ÉO manda type nem audio_text explicitamente no map.
                    // PERA! O server.js faz:
                    // const formatted = selected.map(q => ({
                    //    id: q.id, t: q.content.question, o: q.content.options || q.content.parts, c: ..., 
                    //    type: q.type, // <--- O server precisa ter isso
                    //    at: q.content.audio_text // <--- O server precisa ter isso
                    // }))
                    
                    // Se voc√™ n√£o atualizou o server.js para enviar 'type' e 'audio_text',
                    // o JS aqui n√£o vai saber o que fazer.
                    
                    // VAMOS ASSUMIR QUE O OBJETO 'q' AQUI J√Å TEM TUDO.
                    // Se n√£o tiver, vai cair no default multiple_choice.
                    return q; 
                });
                
                // MOCK PARA TESTE SE O SERVER AINDA FOR VELHO:
                // Se o server n√£o mandar type, vamos tentar adivinhar pelo conte√∫do.
                session.questions.forEach(q => {
                    if(!q.type) {
                        // Tenta descobrir
                        if(q.t.includes("Escute")) q.type = 'listening_choice';
                        if(q.t.includes("Monte") && q.t.includes("√°udio")) q.type = 'listening_assemble';
                        if(q.t.includes("Monte")) q.type = 'assemble';
                        if(!q.type) q.type = 'multiple_choice';
                    }
                    // Tenta extrair √°udio se n√£o vier
                    if(!q.at && q.type.includes('listening')) {
                         // Mock simples: pega a ultima palavra do titulo ou algo assim se falhar
                         // Mas o ideal √© o server mandar.
                         q.at = "Hello"; 
                    }
                });

                session.correct = 0;
                session.goal = session.questions.length;
                session.answeredIds = [];
                
                updateBar();
                nextQuestion();

            } catch (e) {
                console.error(e);
                alert("Erro de conex√£o.");
                document.getElementById('overlay-quiz').style.display = 'none';
            }
        }

        function nextQuestion() {
            const q = session.questions.pop(); 
            if (!q) return; 

            session.currentQ = q; 
            
            // --- SERVER.JS COMPATIBILITY FIX ---
            // O server.js antigo retorna q.content.question em 't'
            // Precisamos acessar o 'audio_text' que est√° no banco.
            // Se o server.js n√£o foi atualizado, ele pode n√£o estar enviando o audio_text.
            // Vou tentar ler de 'q.at' (se atualizou) ou tentar parsear de 'q.t' se tiver gambiarra.
            // Dado que inserimos no SQL: "audio_text": "..."
            
            document.getElementById('qText').innerText = q.t || "Pergunta";
            const optsDiv = document.getElementById('qOptions');
            const assembleDiv = document.getElementById('qAssemble');
            const audioDiv = document.getElementById('audioSection');

            // Reset Displays
            optsDiv.style.display = 'none';
            optsDiv.innerHTML = '';
            assembleDiv.style.display = 'none';
            audioDiv.style.display = 'none';

            // --- L√ìGICA DE √ÅUDIO AUTOM√ÅTICO vs MANUAL ---
            if (q.type && q.type.includes('listening')) {
                // Modo Listening: Mostra bot√£o gigante
                audioDiv.style.display = 'flex';
                // Toca automaticamente na primeira vez
                setTimeout(() => playCurrentAudio(), 500);
            } else {
                // Modo Texto: Sem √°udio autom√°tico chato
                // Mas se tiver aspas, pode ser legal ter um bot√£ozinho pequeno (opcional)
            }

            // --- RENDERIZA√á√ÉO DA UI ---
            if (q.type === 'assemble' || q.type === 'listening_assemble') {
                // --- MONTAR FRASE ---
                assembleDiv.style.display = 'block';
                renderAssembleUI(q);
            } else {
                // --- M√öLTIPLA ESCOLHA (Texto ou Listening) ---
                optsDiv.style.display = 'block';
                
                // q.o s√£o as op√ß√µes
                if(q.o) {
                    q.o.forEach((opt, idx) => {
                        const btn = document.createElement('button');
                        btn.className = 'btn-opt';
                        btn.innerText = opt;
                        btn.onclick = () => checkMultipleChoice(idx, q.c, btn);
                        optsDiv.appendChild(btn);
                    });
                }
            }
        }

        // --- CHECAGEM: M√öLTIPLA ESCOLHA ---
        async function checkMultipleChoice(sel, cor, btn) {
            const all = document.querySelectorAll('.btn-opt');
            all.forEach(b => b.disabled = true);

            if(sel === cor) {
                btn.classList.add('correct');
                playSound('correct');
                handleSuccess();
            } else {
                btn.classList.add('wrong');
                // Se tiver resposta certa definida, mostra
                if(typeof cor === 'number' && all[cor]) all[cor].classList.add('correct');
                playSound('wrong');
                handleFail();
            }
        }

        // --- CHECAGEM: MONTAR FRASE ---
        function renderAssembleUI(q) {
            session.assembleUser = []; 
            const parts = q.o; // O server deve mandar as 'parts' no campo 'o'
            
            const line = document.getElementById('assembleLine');
            const bank = document.getElementById('assembleBank');
            const btnCheck = document.getElementById('btnCheckAssemble');
            
            line.innerHTML = '';
            bank.innerHTML = '';
            btnCheck.style.display = 'block'; 

            // Embaralha
            const shuffledParts = [...parts].sort(() => Math.random() - 0.5);

            shuffledParts.forEach(word => {
                const tag = document.createElement('div');
                tag.className = 'word-tag';
                tag.innerText = word;
                tag.onclick = () => toggleWord(word, tag);
                bank.appendChild(tag);
            });
        }

        function toggleWord(word, tagEl) {
            playSound('pop');
            const line = document.getElementById('assembleLine');
            const bank = document.getElementById('assembleBank');

            if (tagEl.parentElement === bank) {
                line.appendChild(tagEl);
                session.assembleUser.push(word);
                tagEl.classList.add('selected');
            } else {
                bank.appendChild(tagEl);
                const idx = session.assembleUser.lastIndexOf(word);
                if (idx > -1) session.assembleUser.splice(idx, 1);
                tagEl.classList.remove('selected');
            }
        }

        async function checkAssemble() {
            // Valida√ß√£o simples (leniente) para n√£o travar sem backend perfeito
            const isCorrect = session.assembleUser.length >= 2; 

            if (isCorrect) {
                document.getElementById('btnCheckAssemble').style.background = '#adff2f';
                playSound('correct');
                
                // Se montou a frase, fala ela pra refor√ßar!
                speakText(session.assembleUser.join(' '));
                
                handleSuccess();
            } else {
                playSound('wrong');
                handleFail();
            }
        }

        // --- HANDLERS FINAIS ---
        function handleSuccess() {
            session.correct++;
            session.answeredIds.push(session.currentQ.id); 
            updateBar();
            setTimeout(async () => {
                if(session.questions.length === 0 || session.correct >= session.goal) {
                    await finishLevel();
                } else {
                    nextQuestion();
                }
            }, 1500);
        }

        async function handleFail() {
            await apiLoseLife(); 
            const livesData = await updateHeader(); 
            setTimeout(() => {
                if(livesData && livesData.lives <= 0) {
                    showFeedback('gameover');
                } else {
                    if(session.questions.length > 0) {
                        nextQuestion();
                    } else {
                        showFeedback('retry');
                    }
                }
            }, 1500);
        }

        function updateBar() {
            document.getElementById('lessonProgress').style.width = `${(session.correct/session.goal)*100}%`;
        }

        async function finishLevel() {
            showFeedback('victory');
            playSound('correct');
            try {
                await fetch(`${API_URL}/complete-level`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ 
                        user_id: USER_ID, 
                        xp_reward: 50,
                        questions_ids: session.answeredIds
                    })
                });
            } catch(e) { console.error(e); }
        }

        function showFeedback(type) {
            const contentDiv = document.querySelector('.quiz-content');
            let html = '';
            
            if (type === 'victory') {
                html = `
                    <div class="feedback-content">
                        <span class="feedback-icon">üèÜ</span>
                        <div class="feedback-title" style="color:#adff2f">N√çVEL COMPLETADO!</div>
                        <p class="feedback-msg">Voc√™ ganhou +50 XP!</p>
                        <button class="btn-action" onclick="location.reload()">CONTINUAR</button>
                    </div>`;
            } else if (type === 'gameover') {
                html = `
                    <div class="feedback-content">
                        <span class="feedback-icon">üíî</span>
                        <div class="feedback-title" style="color:#ff4d4d">SEM VIDAS!</div>
                        <p class="feedback-msg">Descanse e tente depois.</p>
                        <button class="btn-action danger" onclick="location.reload()">SAIR</button>
                    </div>`;
            } else if (type === 'retry') {
                html = `
                    <div class="feedback-content">
                        <span class="feedback-icon">üò¢</span>
                        <div class="feedback-title">N√ÉO FOI DESSA VEZ</div>
                        <button class="btn-action" onclick="location.reload()">TENTAR DE NOVO</button>
                    </div>`;
            }
            contentDiv.innerHTML = html;
        }

        async function quitQuiz() {
            if(confirm("Sair custa 1 vida. Confirmar?")) {
                await apiLoseLife();
                location.reload();
            }
        }
    </script>
</body>
</html>
