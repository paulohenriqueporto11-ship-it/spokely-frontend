<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spokely - Mapa</title>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div id="loading">CARREGANDO MAPA...</div>

    <header>
        <a href="index.html" class="logo">SPOKELY</a>
        <div class="stats">
            <div class="badge"><span class="material-icons-round icon-heart">favorite</span> <span id="livesDisplay">--</span></div>
            <div class="badge"><span class="material-icons-round icon-xp">bolt</span> <span id="xpDisplay">--</span></div>
        </div>
    </header>

    <main id="mainMap">
        <div class="map-scroll" id="mapTrack">
            </div>
    </main>

    <div id="overlay-quiz" class="overlay">
        <div class="quiz-container">
            <div class="quiz-top">
                <span onclick="quitQuiz()" style="cursor:pointer; color:#888;">‚úï</span>
                <div class="progress-bar"><div id="lessonProgress"></div></div>
                <span style="color:#ff4d4d;">‚ù§</span>
            </div>
            <div class="quiz-content">
                <h2 id="qText" style="margin-bottom:20px;">Carregando...</h2>
                <div id="qOptions"></div>
            </div>
        </div>
    </div>

    <nav class="bottom-nav">
        <a href="index.html" class="nav-link">
            <span class="material-icons-round">home</span> <span>In√≠cio</span>
        </a>
        <a href="map.html" class="nav-link active">
            <span class="material-icons-round">map</span> <span>Estudar</span>
        </a>
        <a href="profile.html" class="nav-link">
            <span class="material-icons-round">person</span> <span>Perfil</span>
        </a>
    </nav>

    <script src="script.js"></script>
   <script>
    // --- VARI√ÅVEIS GLOBAIS ---
    let currentLevel = 1;
    let session = { correct: 0, goal: 5, questions: [], answeredIds: [] };

    // Carrega Mapa
    window.addEventListener('load', async () => {
        const data = await updateHeader(); // Vem do script.js
        if(data) {
            currentLevel = data.current_level || 1;
            renderMap();
            setTimeout(scrollToLevel, 300);
        }
    });

    function renderMap() {
        const track = document.getElementById('mapTrack');
        track.innerHTML = ''; 
        for (let i = 1; i <= 50; i++) { 
            const node = document.createElement('div');
            node.className = 'node';
            node.innerText = i;
            if (i < currentLevel) {
                node.classList.add('done');
                node.innerText = '‚úì';
            } else if (i === currentLevel) {
                node.classList.add('curr');
                const av = document.createElement('div');
                av.className = 'avatar';
                node.appendChild(av);
                node.onclick = () => startSession();
            } else {
                node.classList.add('locked');
                node.innerHTML = '<span class="material-icons-round">lock</span>';
            }
            track.appendChild(node);
        }
    }

    function scrollToLevel() {
        const el = document.querySelector('.node.curr');
        if(el) el.scrollIntoView({ inline: 'center', behavior: 'smooth' });
    }

    // --- SISTEMA DE QUIZ CONECTADO AO BACKEND ---
    async function startSession() {
        const lives = document.getElementById('livesDisplay').innerText;
        if(parseInt(lives) <= 0) return alert("Sem vidas! üíî");
        
        // UI de Carregamento
        document.getElementById('overlay-quiz').style.display = 'flex';
        document.getElementById('qText').innerText = "Carregando atividade...";
        document.getElementById('qOptions').innerHTML = "";

        // Define dificuldade (Pode criar um seletor depois, por enquanto vai easy)
        const difficulty = 'easy'; 

        try {
            // BUSCA PERGUNTAS NO SERVIDOR
            const res = await fetch(`${API_URL}/get-activity?user_id=${USER_ID}&difficulty=${difficulty}`);
            const data = await res.json();

            if(!data.success) {
                alert(data.error || "Erro ao buscar atividades.");
                document.getElementById('overlay-quiz').style.display = 'none';
                return;
            }

            // Prepara a sess√£o
            session.questions = data.questions;
            session.correct = 0;
            session.goal = session.questions.length;
            session.answeredIds = [];
            
            updateBar();
            nextQuestion();

        } catch (e) {
            console.error(e);
            alert("Erro de conex√£o.");
            document.getElementById('overlay-quiz').style.display = 'none';
        }
    }

    function nextQuestion() {
        // Pega a pr√≥xima pergunta da lista
        const q = session.questions.pop(); 
        
        if (!q) {
             // Seguran√ßa caso acabe
             return; 
        }

        // Salva a pergunta atual para confer√™ncia
        session.currentQ = q; 

        document.getElementById('qText').innerText = q.t;
        const opts = document.getElementById('qOptions');
        opts.innerHTML = '';
        
        q.o.forEach((opt, idx) => {
            const btn = document.createElement('button');
            btn.className = 'btn-opt';
            btn.innerText = opt;
            btn.onclick = () => check(idx, q.c, btn);
            opts.appendChild(btn);
        });
    }

    async function check(sel, cor, btn) {
        const all = document.querySelectorAll('.btn-opt');
        all.forEach(b => b.disabled = true);

        if(sel === cor) {
            btn.classList.add('correct');
            session.correct++;
            session.answeredIds.push(session.currentQ.id); // Salva ID para n√£o repetir
            updateBar();
            
            setTimeout(async () => {
                if(session.questions.length === 0) {
                    // Se acertou o necess√°rio ou acabaram as perguntas do lote
                    if(session.correct >= session.goal || session.questions.length === 0) {
                         await finishLevel();
                    }
                } else {
                    nextQuestion();
                }
            }, 1000);
        } else {
            btn.classList.add('wrong');
            // Mostra a correta
            all[cor].classList.add('correct');
            
            await apiLoseLife();
            const lives = await updateHeader(); 
            if(lives.lives <= 0) {
                alert("Game Over!");
                location.reload();
            } else {
                // Errou? Segue o jogo se ainda tiver perguntas
                if(session.questions.length > 0) {
                    setTimeout(nextQuestion, 1500);
                } else {
                    alert("Voc√™ errou na √∫ltima pergunta. Tente novamente!");
                    location.reload();
                }
            }
        }
    }

    function updateBar() {
        document.getElementById('lessonProgress').style.width = `${(session.correct/session.goal)*100}%`;
    }

    async function finishLevel() {
        try {
            const res = await fetch(`${API_URL}/complete-level`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ 
                    user_id: USER_ID, 
                    xp_reward: 50,
                    questions_ids: session.answeredIds // Envia os IDs para salvar no hist√≥rico
                })
            });
            const data = await res.json();
            if(data.success) {
                alert("N√çVEL COMPLETADO! üéâ");
                location.reload();
            }
        } catch(e) { console.error(e); }
    }

    async function quitQuiz() {
        if(confirm("Sair custa 1 vida. Confirmar?")) {
            await apiLoseLife();
            location.reload();
        }
    }
</script>
</body>
</html>
